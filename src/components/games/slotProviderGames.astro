---
import qs from 'qs'
import { urlTranslate } from '../../../utils/data-store.util'
import fetchApi from '../../../lib/strapi';
import { gamesQs } from "../../../qs/ssm-games"
import GameListBlock from '../../components/blocks/gameListBlock.svelte';
import Pagination from '../../components/helpers/pagination.astro';

const { slug } = Astro.props
const newSlug = slug.includes('/') ? slug.split('/')[0] : slug;
const page = slug.includes('/') ? slug.split('/')[1].split('p')[1] : 1;

const query = qs.stringify(gamesQs(newSlug,"views:desc",page), {encodeValuesOnly: true});
const games = await fetchApi<any>({
    endpoint: 'games',
    isPaginated: true,
    query: `?${query}`
});

let siteID = import.meta.env.SITE_ID

const gameBlock = {
    numberOfGames: 36,
    sortBy: "Most Popular",
    showGameFilterPanel: true,
    showGameMoreButton: false,
    gameCategories: [],
    gameProviders: [{
            slotProvider: {
                data: {
                    attributes: {
                        slug: newSlug
                    }
                }
            }
        }]
    
}
---
<GameListBlock data={gameBlock} {page} client:load />

<Pagination
    currPage={games?.meta?.pagination?.page}
    pageCount={games?.meta?.pagination?.pageCount}
    path=`${urlTranslate[siteID as keyof typeof urlTranslate]['provider-pages']}/${newSlug}`
/>