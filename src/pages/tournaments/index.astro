---
import qs from "qs";
import fetchApi from "../../../lib/strapi";
import MainLayout from "../../layouts/MainLayout.astro";
import { getTranslations } from "../../../utils/api-requests";
import { tournamentApi } from "../../../lib/tournamentapi";
import type {
  Tournament,
  TournamentResponse,
  TournamentPageAttributes,
} from "../../../interfaces/tournaments";
import { tournamentsQs } from "../../../qs/tournaments";
import PastResults from "../../components/tournaments/pastResults.astro";
import Breadcrumb from "../../components/layout/breadcrumbs.astro";
import TournamentCard from "../../components/tournaments/tournamentCard.svelte";
import Images from "../../components/helpers/images.astro";
import Faqs from "../../components/general/faqs.astro";

// Fetch translations for the page
const translationStore = await getTranslations();

// Build the query string for Strapi API
const query = qs.stringify(tournamentsQs(), { encodeValuesOnly: true });
// Fetch tournament page content from Strapi
const tournamentContent = await fetchApi<TournamentPageAttributes>({
  endpoint: "tournament",
  wrappedByKey: "data",
  query: `?${query}`,
});

// Initialize state variables
let tournaments: Tournament[] = [];
let liveTournamentResults: Tournament[] = [];
let error = null;

// API functions for different tournament types
const getTournaments = async () => {
  return tournamentApi<TournamentResponse>("getTournamentFullSchedule");
};

const getLiveTournament = async () => {
  return tournamentApi<TournamentResponse>("getLiveTournaments");
};

// Fetch all tournament data
try {
  const tournamentResponse = await getTournaments();
  const liveTournamentResponse = await getLiveTournament();

  tournaments = tournamentResponse.data || [];
  liveTournamentResults = liveTournamentResponse.data || [];
} catch (e) {
  console.error("Error fetching tournaments:", e);
  error = e instanceof Error ? e.message : "Unknown error occurred";
}

// SEO configuration
const seo = {
  pageTitle: translationStore?.tournamentPageTitle || "Tournaments",
  metaDescription:
    translationStore?.tournamentPageDescription ||
    "View all active tournaments",
  url: `${import.meta.env.PUBLIC_FULL_URL}/tournaments`,
};

// Cache Control Headers for performance
Astro.response.headers.set(
  "Cache-Control",
  "public, max-age=0, must-revalidate"
);

Astro.response.headers.set(
  "Cache-Control",
  "public, max-age=300, s-maxage=3600, stale-while-revalidate=30"
);

// Breadcrumb navigation configuration
const breadcrumbs = [
  { title: translationStore?.home || "Home", href: "/" },
  {
    title: translationStore?.tournaments || "Tournaments",
    href: "/tournaments",
    current: true,
  },
];
---

<MainLayout seoData={seo}>
  {/* Breadcrumb Navigation */}
  <Breadcrumb
    breadcrumbs={[
      { id: 1, breadCrumbText: "Home", breadCrumbUrl: "/" },
      { id: 2, breadCrumbText: "Tournaments", breadCrumbUrl: null },
    ]}
  />

  {/* Hero Section with Tournament Information */}
  <div class="featured-background curve">
    <section
      class="bg-casino-gradient pt-24 pb-12 px-4 text-center text-white relative"
    >
      {/* Hero Content */}
      <h1 class="text-5xl md:text-6xl mb-4 font-bold">
        {tournamentContent?.attributes?.tournamentPageHeader}
      </h1>
      <p class="text-xl md:text-2xl text-white/90 max-w-3xl mx-auto">
        {tournamentContent?.attributes?.tournamentPageSubHeader}
      </p>

      {/* How To Get Involved Section */}
      <h2 class="mt-24 mb-12 font-bold text-white">How To Get Involved</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-8 max-w-6xl mx-auto">
        {/* Registration Steps */}
        {
          tournamentContent?.attributes?.tournamentRegisterSteps?.map(
            (step, index) => (
              <div class="p-2.5 bg-white/5 rounded-2xl backdrop-blur-lg transition-all duration-300 ease-in-out hover:scale-105">
                <div class="bg-white/10 m-[1.5px] p-6 rounded-xl relative overflow-hidden">
                  {/* Background Image with Overlay */}
                  {step.backgroundImage?.data?.attributes?.url && (
                    <div class="absolute inset-0 -z-10">
                      <Images
                        src={step.backgroundImage.data.attributes.url}
                        imageWidth={360}
                        imageHeight={250}
                        classes="w-full h-full object-cover"
                        alt={`Step ${index + 1} background`}
                      />
                      <div class="absolute inset-0 bg-background-900/80" />
                    </div>
                  )}

                  {/* Step Content */}
                  <div class="relative z-10">
                    <div class="flex justify-center items-center mb-4">
                      {/* <Images
                        src={step.icon?.data?.attributes?.url}
                        imageWidth={50}
                        imageHeight={50}
                        classes="rounded-lg"
                        alt={`Step ${index + 1} icon`}
                      /> */}
                    </div>
                    <h3 class="text-xl text-white mb-4 text-center">
                      {index + 1}. {step.heading}
                    </h3>
                    <p class="text-white/80 leading-relaxed text-center">
                      {step.content}
                    </p>
                  </div>
                </div>
              </div>
            )
          )
        }
      </div>

      {/* Partnership Logo Section */}
      <div class="flex flex-col items-center justify-center mt-5">
        <p class="text-white text-sm mb-3">In partnership with</p>
        <Images
          src={tournamentContent?.attributes?.partnerships.data[0]?.attributes?.url}
          imageWidth={110}
          imageHeight={48}
          classes="rounded-lg"
          alt="Pragmatic Play Logo"
        />
      </div>
    </section>
  </div>

  {/* Main Content Section */}
  <div class="xl:container content-auto px-2 pt-5">
    {/* Live Tournaments Section */}
    <section class="py-20 px-4">
      <div class="max-w-6xl mx-auto">
        <h2 class="text-4xl font-bold mb-12 text-center">Live Tournaments</h2>
        <div class="grid md:grid-cols-3 gap-8">
          {
            liveTournamentResults.map((tournament) => (
              <TournamentCard client:load tournament={tournament} />
            ))
          }
        </div>
      </div>
    </section>

    {/* Past Tournament Results */}
    <PastResults />

    {/* FAQ Section */}
    <section class="py-20 px-4 bg-gray-800">
      <div class="mx-auto">
        <h2 class="text-4xl font-bold mb-12 text-center">
          Frequently Asked Questions
        </h2>Â®
        <div class="space-y-4">
          {
            tournamentContent?.attributes?.faqs.map((faq) => (
              <Faqs data={faq} />
            ))
          }
        </div>
      </div>
    </section>
  </div>
</MainLayout>
