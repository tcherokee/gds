---
export const prerender = true;
import type { GetStaticPaths } from "astro";
import qs from 'qs';
import type { Blog, BlogList } from "../../../interfaces/blog";
import fetchApi from '../../../lib/strapi';
import { blogcardQs } from "../../../qs/blog-cards";
import { blogmetaQs } from "../../../qs/blog-meta";
import { blogpageQs } from "../../../qs/blog-page";
import { getTranslations } from "../../../utils/api-requests";
import { urlTranslate } from '../../../utils/data-store.util';
import BlogListBlock from '../../components/blocks/blogListBlock.astro';
import AuthorCard from '../../components/general/authorCard.astro';
import Images from '../../components/helpers/images.astro';
import Pagination from '../../components/helpers/pagination.astro';
import TimeDate from '../../components/helpers/timeDate.astro';
import MainLayout from '../../layouts/MainLayout.astro';

const translationStore = await getTranslations();


export const getStaticPaths = (async () => {

	const query1 = qs.stringify(blogcardQs(12, 1), {encodeValuesOnly: true})

    const blogCards = await fetchApi<BlogList>({
        endpoint: 'blogs',
        isPaginated: true,
        query: `?${query1}`
    })
	

	let prerenderPath: any[] = [];

    for (let i = 1; i <= blogCards.meta.pagination.pageCount; i++) {
        const slug = `p${i}`;
        const query = qs.stringify(blogcardQs(12, i), { encodeValuesOnly: true});
        const blogs = await fetchApi<any>({
            endpoint: "blogs",
            isPaginated: true,
            query: `?${query}`,
        });
        

        prerenderPath.push({
            params: { slug },
            props: { page: blogs, isPaginated: true },
        });
    }

    // Import the QS Query string for custom slugs and prepare it for the API fetch
    const query = qs.stringify(blogpageQs(), {encodeValuesOnly: true})
    // Request to the Fetch Function to get page data from API
    const blog = await fetchApi<Blog[]>({
		endpoint: 'blogs',
		wrappedByKey: 'data',
		query: `?${query}`
	})

	for (const b of blog) {
		 prerenderPath.push({
            params: { slug: b?.attributes?.slug },
            props: { page: b, isPaginated: false },
        });
	}

	return prerenderPath

}) satisfies GetStaticPaths;

const { page, isPaginated } = Astro.props
const { slug } = Astro.params; //get the slug from the page url

// get blog cards for side menu
const blogCardquery = qs.stringify(blogcardQs(3, 1), {encodeValuesOnly: true})
const blogCards = await fetchApi<BlogList>({
	endpoint: 'blogs',
    wrappedByKey: 'data',
    query: `?${blogCardquery}`
})

const metaQuery = qs.stringify(blogmetaQs(), {encodeValuesOnly: true})
const layoutData = await fetchApi<any>({
	endpoint: 'layout',
    wrappedByKey: 'data',
    query: `?${metaQuery}`
})

const siteID = import.meta.env.SITE_ID
const siteURL = import.meta.env.FULL_URL
const canonical =  isPaginated ? `${siteURL}${urlTranslate[siteID as keyof typeof urlTranslate]['blog-index']}/${slug}` 
					: `${siteURL}${urlTranslate[siteID as keyof typeof urlTranslate]['blog-pages']}/${page?.attributes?.slug}`

//set page seo data
let seo = {
    pageTitle: page?.attributes?.seo?.metaTitle ?? layoutData?.attributes?.blogMeta?.blogTitle,
    metaDescription: page?.attributes?.seo?.metaDescription ?? layoutData?.attributes?.blogMeta?.blogDescription,
    url: canonical
}

---

<MainLayout seoData={seo}>
	{ isPaginated ?
		<div class="curve mb-5">
			<div class="xl:container px-2 pb-5 pt-4">
				<BlogListBlock data={page.data} />
		
				<Pagination 
				currPage={page?.meta?.pagination?.page} 
				pageCount={page?.meta?.pagination?.pageCount} 
				path={urlTranslate[siteID as keyof typeof urlTranslate]['blog-pages']}
				{translationStore} />
			</div>
		</div>
	:
		<div class="blog-bg relative after:content-['']">
			<div class="relative xl:container px-2 pb-5 pt-4">
				<div class="md:flex md:-mx-3 [&>*]:px-3">
					<div class="md:w-4/6">
						<h1>
							{page?.attributes?.title}
						</h1>
						<span class="text-white flex items-center gap-2 mb-4">
							<TimeDate timeDate={page?.attributes?.createdAt} />
							<!-- <HeaderAuthor author={page?.attributes?.author} />  -->
						</span>

						<div class="mb-5">
							<Images
								src={page?.attributes?.images?.data?.attributes?.url}
								alt={page?.attributes?.title}
								imageWidth={820}
								imageHeight={550}
							/>
						</div>
						<div class="blog-content">
							<Fragment set:html={page?.attributes?.content1} />
						</div>
						{page?.attributes?.author?.data &&
							<div class="mt-10 mb-10 md:mb-0">
								<AuthorCard data={page?.attributes?.author} />
							</div>
						}
					</div>
					<div class="md:w-2/6 sidebar">
					<BlogListBlock data={blogCards} singleBlogPage={true} />
				</div>
				</div>
			</div>
		</div>
	}	
</MainLayout>

<style lang="scss">
	:global(figure.center-image) {
		@apply flex justify-center;
	}
	.blog-bg{
		background: linear-gradient(to bottom, theme('colors.background-bottom-gradient'), theme('colors.background-top-gradient') 300px, theme('colors.body-bg') 900px, theme('colors.body-bg'));
	}
	:global(.blog-content) {
		img {
			@apply w-full;
		}
		:global(a) {
			@apply text-quicklinks-btn-color;
		}
		:global(h1),
		:global(h2),
		:global(h3),
		:global(h4),
		:global(h5),
		:global(h6) {
			@apply mb-4 mt-10;
		}

		:global(ul),
		:global(ol) {
			@apply ml-[35px];
			list-style-image: none;
		}
		:global(li) {
			@apply relative list-none;
			&:not(:last-child) {
				@apply mb-4;
			}
		}
		:global(li::before) {
			@apply absolute -left-5 w-[14px] h-[14px] top-[50%];
			content: '';
			background: url('../../assets/circle-chevron-right.svg') no-repeat center center/cover;
			transform: translate(0, -50%);
		}
	}

	:global(.sidebar) {
		:global(.blog-card) {
			@apply mb-[10px];
		}
	}
</style>
